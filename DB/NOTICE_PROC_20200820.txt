create or replace PACKAGE PKG_NOTICE AS 

PROCEDURE PROC_NOTICE_FILTER_LIST
  (
    O_CUR OUT SYS_REFCURSOR
  );
  
 PROCEDURE PROC_NOTICE_TABLE_LIST
  (
    IN_MEMID IN CHAR,
    O_CUR OUT SYS_REFCURSOR
  ) ;  
 
 PROCEDURE PROC_NOTICE_INSERT
  (
    IN_MENUID IN CHAR,
    IN_TITLE  IN VARCHAR2,
    IN_CONT     IN VARCHAR2,
    IN_MID     IN VARCHAR2,
    IN_BNUM     IN NUMBER,
    IN_LVL     IN NUMBER,
    IN_STEP   IN NUMBER,
    IN_NREF   IN NUMBER,
    --파일 업로드에 대한 추가 항목 
    IN_FILENAMES IN FILE_ARRAY,
    IN_FILEEXTS  IN FILE_ARRAY,
    IN_SFILENAMES IN FILE_ARRAY
  );

 PROCEDURE PROC_NOTICE_PLUS_READCOUNT
 (
    IN_IDX  IN  NUMBER  
 );
 
END PKG_NOTICE;


-----------------------------  바디 부분 

create or replace PACKAGE BODY PKG_NOTICE AS

  PROCEDURE PROC_NOTICE_FILTER_LIST
  (
    O_CUR OUT SYS_REFCURSOR
  ) AS
  BEGIN
    OPEN O_CUR FOR
    SELECT MENU_ID, MENU_NAME, MENU_SEQ
    FROM MENUS;
    
  END PROC_NOTICE_FILTER_LIST;

  PROCEDURE PROC_NOTICE_TABLE_LIST
  (
    IN_MEMID IN CHAR,
    O_CUR OUT SYS_REFCURSOR
  ) 
  AS
  BEGIN
  
  IF IN_MEMID = 'all' 
  THEN 
  
  OPEN O_CUR FOR
SELECT T1.IDX, T1.MENU_ID, T1.TITLE, T1.CONT, T1.MID, T3.MNAME,  
 REGDATE, 
T1.READCOUNT,
T1.BNUM, T1.LVL, T1.STEP, T1.NREF, T1.DELNUM, NVL(DECODE (INSTR(T2.SUMNAIL, 'f'), 1,T2.SUMNAIL ), 'files/pkg_1471006861_notice_white_BG.jpg' ) AS SUMNAIL
FROM BOARD T1,
(SELECT IDX, SUBSTR(CT, INSTR(CT, 'files'), (INSTR(CT, '"', 1, 4) - INSTR(CT, 'files'))) AS SUMNAIL FROM
(
SELECT IDX, SUBSTR(CONT, INSTR(CONT, '<img'), (INSTR(CONT, '/>') - INSTR(CONT,  '<img'))) AS CT
FROM BOARD
)
) T2, MEMBERS T3
WHERE T1.IDX = T2.IDX
AND T1.MID = T3.MID(+)
ORDER BY T1.IDX DESC;
  
  ELSE  
  OPEN O_CUR FOR
  
SELECT T1.IDX, T1.MENU_ID, T1.TITLE, T1.CONT, T1.MID, T3.MNAME,  
 REGDATE, 
T1.READCOUNT,
T1.BNUM, T1.LVL, T1.STEP, T1.NREF, T1.DELNUM, NVL(DECODE (INSTR(T2.SUMNAIL, 'f'), 1,T2.SUMNAIL ), 'files/pkg_1471006861_notice_white_BG.jpg' ) AS SUMNAIL
FROM BOARD T1,
(SELECT IDX, SUBSTR(CT, INSTR(CT, 'files'), (INSTR(CT, '"', 1, 4) - INSTR(CT, 'files'))) AS SUMNAIL FROM
(
SELECT IDX, SUBSTR(CONT, INSTR(CONT, '<img'), (INSTR(CONT, '/>') - INSTR(CONT,  '<img'))) AS CT
FROM BOARD
)
) T2, MEMBERS T3
WHERE T1.IDX = T2.IDX
AND T1.MID = T3.MID(+)
AND MENU_ID = IN_MEMID
ORDER BY T1.BNUM DESC;



  END IF;
  
    
END PROC_NOTICE_TABLE_LIST;

PROCEDURE PROC_NOTICE_INSERT
  (
    IN_MENUID IN CHAR,
    IN_TITLE   IN VARCHAR2,
    IN_CONT    IN VARCHAR2,
    IN_MID   IN VARCHAR2,
    IN_BNUM   IN NUMBER,
    IN_LVL   IN NUMBER,
    IN_STEP IN NUMBER,
    IN_NREF IN NUMBER,
    --파일 업로드에 대한 추가 항목 
    IN_FILENAMES IN FILE_ARRAY,
    IN_FILEEXTS  IN FILE_ARRAY,
    IN_SFILENAMES IN FILE_ARRAY
  ) AS
  
    V_BNUM      NUMBER(5, 0);
    V_LVL       NUMBER(5, 0);
    V_STEP      NUMBER(5, 0);
    V_NREF      NUMBER(5, 0);
    V_MAXIDX    NUMBER(5, 0);
  
  BEGIN
    
    IF IN_BNUM = 0 THEN --새글을 위한 변수처리 
    SELECT NVL(MAX(BNUM),0) + 1
    INTO V_BNUM FROM BOARD
    WHERE MENU_ID = IN_MENUID;
    
    V_LVL := 0;
    V_STEP := 0;
    
    SELECT NVL( MAX(NREF), 0 ) + 1 
    INTO V_NREF FROM BOARD
    WHERE MENU_ID = IN_MENUID;
    
    ELSE    -- 답글 처리
            V_BNUM  := IN_BNUM;
            V_LVL   := IN_LVL + 1;
            V_STEP  := IN_STEP + 1;
            V_NREF  := IN_NREF;
            
            -- 기존 답글에 대한 순서 + 1
            UPDATE  BOARD
            SET     STEP    = STEP + 1
            WHERE   MENU_ID  = IN_MENUID
            AND     NREF    = IN_NREF
            AND     STEP    > IN_STEP
            ;
        END IF;
    
    INSERT INTO BOARD (IDX, MENU_ID, TITLE, CONT, MID,
    REGDATE, READCOUNT, BNUM, LVL, STEP, NREF, LIKECOUNT)
    VALUES (BRDSEQ.NEXTVAL, IN_MENUID, IN_TITLE, IN_CONT, IN_MID,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH:MI:SS'), 0, 
    V_BNUM, V_LVL, V_STEP, V_NREF, 0);
    
    -- 가장 마지막에 추가 된 글의 IDX 구하는 쿼리
    SELECT MAX(IDX) INTO V_MAXIDX FROM BOARD;
    
    -- 여러 FILE 처리 
    IF IN_FILENAMES(1) IS NOT NULL THEN -- 배열의 첫번째 -> 오라클에서는 1번 부터 
    -- 첫번째에 파일이 있는지 확인 
    FOR I IN IN_FILENAMES.FIRST .. IN_FILENAMES.LAST
    LOOP 
     INSERT INTO FILES
     VALUES (
     (SELECT NVL(MAX(FILE_NUM), 0) +1 FROM FILES),
     V_MAXIDX, -- 마지막에 추가된 게시글 번호 
     IN_FILENAMES(I),
     IN_FILEEXTS(I),
     IN_SFILENAMES(I));
    END LOOP;
  
    END IF;
    
  END PROC_NOTICE_INSERT;

  PROCEDURE PROC_NOTICE_PLUS_READCOUNT
 (
    IN_IDX  IN  NUMBER  
 ) AS
  BEGIN
    UPDATE BOARD
    SET READCOUNT = READCOUNT +1
    WHERE IDX = IN_IDX;
 
  END PROC_NOTICE_PLUS_READCOUNT;

END PKG_NOTICE;

